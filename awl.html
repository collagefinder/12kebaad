<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>All Colleges (awl) — 12kebaad</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<!-- Minimal page-specific styling (keeps your theme) -->
<style>
  :root{
    --brand1:#004aad; --brand2:#0078ff; --card-bg:#ffffff; --muted:#667;
  }
  body{font-family:'Poppins',sans-serif;margin:0;background:#f7f9fc;color:#111}
  header{background:linear-gradient(135deg,var(--brand1),var(--brand2));color:#fff;padding:14px 0}
  .container{width:95%;max-width:1100px;margin:18px auto}
  .title-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.3rem}
  .sub{color:#eef6ff;opacity:0.95;margin-left:8px;font-weight:500}
  .controls{display:flex;flex-wrap:wrap;gap:10px;margin:14px 0;align-items:center}
  select,input,button{padding:10px;border-radius:8px;border:1px solid #e3eefc;font-size:0.95rem}
  select:focus,input:focus{outline:none;border-color:var(--brand2);box-shadow:0 0 6px rgba(0,120,255,0.12)}
  button{background:var(--brand1);color:#fff;border:0;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:12px;margin-top:12px}
  .card{background:var(--card-bg);padding:14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
  .card h3{margin:0 0 6px 0;color:var(--brand1)}
  .meta{font-size:0.9rem;color:var(--muted);margin:4px 0}
  .pill{display:inline-block;padding:6px 8px;border-radius:999px;background:#eef6ff;color:var(--brand1);font-weight:600;margin-right:6px;font-size:0.85rem}
  .pager{display:flex;gap:8px;align-items:center;margin-top:12px}
  .status{margin-left:auto;color:#444;font-size:0.95rem}
  .loader{display:inline-block;width:14px;height:14px;border-radius:50%;border:3px solid rgba(255,255,255,0.18);border-top-color:#fff;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  a.small-link{color:var(--brand1);text-decoration:none;font-weight:600}
  @media (max-width:640px){ .controls { gap:8px } }
</style>
</head>
<body>
<header>
  <div class="container">
    <div class="title-row">
      <h1>12kebaad — All Colleges</h1>
      <div class="sub">Filtered by selected course & state</div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Filters & search -->
  <div class="controls">
    <label>
      <select id="stateFilter" title="State / UT">
        <option value="">All States</option>
      </select>
    </label>

    <label>
      <select id="courseFilter" title="Course">
        <option value="">All Courses</option>
      </select>
    </label>

    <label>
      <select id="ownershipFilter" title="Ownership">
        <option value="">Any Ownership</option>
        <option value="Government">Government</option>
        <option value="Private">Private</option>
        <option value="Deemed">Deemed</option>
      </select>
    </label>

    <label>
      <select id="modeFilter" title="Mode">
        <option value="">Any Mode</option>
        <option value="Offline">Offline</option>
        <option value="Online">Online</option>
        <option value="Hybrid">Hybrid</option>
      </select>
    </label>

    <input id="searchBox" placeholder="Search by college name or city..." style="min-width:220px;flex:1" />
    <button id="btnReload">Reload</button>
    <button id="btnExport">Export</button>
  </div>

  <div style="display:flex;align-items:center;gap:12px">
    <div id="filterInfo" style="color:#444"></div>
    <div class="status" id="status">Waiting to load <a class="small-link" href="colleges.csv" id="csvLink" target="_blank">colleges.csv</a></div>
  </div>

  <div id="grid" class="grid" aria-live="polite"></div>

  <div class="pager" style="margin-top:18px">
    <button id="prevBtn">&larr; Prev</button>
    <button id="nextBtn">Next &rarr;</button>
    <div style="margin-left:12px">Page <span id="pageNum">1</span></div>
    <div class="status" id="stats"></div>
  </div>
</main>

<!-- PapaParse (streaming CSV parse) -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>
/*
  awl.html
  - Expects colleges.csv in same folder (or set DATA_URL)
  - Filters by URL params: course, state (case-insensitive)
  - Uses PapaParse to stream parse CSV (worker:true)
  - Minimal mapping in normalizeRow() — edit if your CSV has different headers
*/

// CONFIG
const DATA_URL = 'colleges.csv'; // or full raw GitHub URL
const PAGE_SIZE = 20;

// UI refs
const stateFilter = document.getElementById('stateFilter');
const courseFilter = document.getElementById('courseFilter');
const ownershipFilter = document.getElementById('ownershipFilter');
const modeFilter = document.getElementById('modeFilter');
const searchBox = document.getElementById('searchBox');
const statusEl = document.getElementById('status');
const csvLink = document.getElementById('csvLink');
const grid = document.getElementById('grid');
const filterInfo = document.getElementById('filterInfo');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
const pageNum = document.getElementById('pageNum');
const stats = document.getElementById('stats');
const btnReload = document.getElementById('btnReload');
const btnExport = document.getElementById('btnExport');

csvLink.href = DATA_URL;

// STATE
let rows = [];            // all parsed rows
let filtered = [];        // current filtered result
let statesSet = new Set();
let coursesSet = new Set();
let page = 1;
let parsing = false;

// read URL params to pre-filter
const params = new URLSearchParams(window.location.search);
const preCourse = params.get('course') || params.get('Course') || '';
const preState = params.get('state') || params.get('State') || '';

// initialize
startParsing();

// Start streaming parse
function startParsing(){
  parsing = true;
  rows = [];
  statesSet.clear();
  coursesSet.clear();
  page = 1;
  statusEl.innerHTML = 'Loading <span class="loader"></span>';

  Papa.parse(DATA_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    worker: true,
    step: function(results) {
      const raw = results.data;
      const r = normalizeRow(raw);
      if (!r || !r.name) return;
      rows.push(r);

      if (r.state) statesSet.add(r.state);
      (r.courses || []).forEach(c => coursesSet.add(c));

      // occasionally update status
      if (rows.length % 1000 === 0) statusEl.textContent = `Parsed ${rows.length} rows...`;
    },
    complete: function() {
      parsing = false;
      statusEl.textContent = `Loaded ${rows.length} records.`;
      buildFilters();
      applyFilters(); // show results (will include preCourse & preState)
    },
    error: function(err) {
      parsing = false;
      statusEl.textContent = 'Failed to load CSV: ' + err.message;
      console.error(err);
    }
  });
}

// Normalize CSV row -> object with fields used below
function normalizeRow(raw){
  // Edit this mapping if your CSV uses different headers
  const r = {};
  r.id = raw.id || raw.ID || '';
  r.name = (raw.name || raw.Name || raw.institution || '').trim();
  r.type = (raw.type || raw.Type || raw.institution_type || '').trim(); // College / University
  r.ownership = (raw.ownership || raw.govt_private || raw.ownership_type || '').trim(); // Government/Private/Deemed
  r.mode = (raw.mode || raw.online_offline || raw.mode_of_teaching || '').trim(); // Online/Offline/Hybrid
  r.state = (raw.state || raw.State || raw.State_UT || '').trim();
  r.city = (raw.city || raw.City || raw.town || '').trim();
  const coursesRaw = raw.courses || raw.COURSES || raw.courses_offered || '';
  r.courses = String(coursesRaw).split(/[,|;]+/).map(s => s.trim()).filter(Boolean);
  r.fees = (raw.fees || raw.Fees || raw.annual_fees || '').toString().trim();
  r.admission = (raw.admission || raw.Admission || raw.entry || '').trim();
  r.cutoff = (raw.cutoff || raw.Cutoff || raw.cut_off || '').trim();
  r.website = (raw.website || raw.Website || raw.url || '').trim();
  return r;
}

// Build options for filters
function buildFilters(){
  // states
  const states = Array.from(statesSet).sort((a,b)=>a.localeCompare(b));
  stateFilter.innerHTML = '<option value="">All States</option>' + states.map(s => `<option value="${escapeHtml(s)}">${s}</option>`).join('');

  // courses
  const courses = Array.from(coursesSet).sort((a,b)=>a.localeCompare(b));
  courseFilter.innerHTML = '<option value="">All Courses</option>' + courses.map(c => `<option value="${escapeHtml(c)}">${c}</option>`).join('');

  // apply URL pre-filters
  if (preState) {
    const match = states.find(s => s.toLowerCase() === preState.toLowerCase());
    if (match) stateFilter.value = match;
  }
  if (preCourse) {
    const matchC = courses.find(c => c.toLowerCase() === preCourse.toLowerCase());
    if (matchC) courseFilter.value = matchC;
  }
}

// Apply filters/search
function applyFilters(){
  const st = (stateFilter.value || '').toLowerCase();
  const course = (courseFilter.value || '').toLowerCase();
  const ownership = (ownershipFilter.value || '').toLowerCase();
  const mode = (modeFilter.value || '').toLowerCase();
  const q = (searchBox.value || '').toLowerCase();

  filtered = rows.filter(r => {
    if (st && (!r.state || r.state.toLowerCase() !== st)) return false;
    if (ownership && (!r.ownership || r.ownership.toLowerCase() !== ownership)) return false;
    if (mode && (!r.mode || r.mode.toLowerCase() !== mode)) return false;
    if (course) {
      const found = (r.courses || []).some(c => c.toLowerCase() === course || c.toLowerCase().includes(course));
      if (!found) return false;
    }
    if (q) {
      const hay = ((r.name||'') + ' ' + (r.city||'') + ' ' + (r.state||'') + ' ' + (r.courses||[]).join(' ')).toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  });

  page = 1;
  renderPage();
  // show filter info
  filterInfo.textContent = `${filtered.length} matches`;
}

// Render one page of results
function renderPage(){
  const total = filtered.length;
  const start = (page - 1) * PAGE_SIZE;
  const end = Math.min(start + PAGE_SIZE, total);
  const slice = filtered.slice(start, end);

  if (!slice.length) {
    grid.innerHTML = `<div style="padding:20px;background:#fff;border-radius:10px">No colleges found for selected filters.</div>`;
  } else {
    grid.innerHTML = slice.map(r => `
      <article class="card">
        <h3>${escapeHtml(r.name)}</h3>
        <div class="meta"><span class="pill">${escapeHtml(r.type || r.ownership || '')}</span> ${escapeHtml(r.city || '')}, ${escapeHtml(r.state || '')}</div>
        <div class="meta"><strong>Courses:</strong> ${escapeHtml((r.courses||[]).slice(0,6).join(', '))}${(r.courses && r.courses.length>6)?' …':''}</div>
        <div class="meta"><strong>Admission:</strong> ${escapeHtml(r.admission || 'Varies')} • <strong>Cutoff:</strong> ${escapeHtml(r.cutoff || 'Varies')}</div>
        <div class="meta"><strong>Fees:</strong> ${escapeHtml(r.fees || 'Varies')} • <a href="${escapeHtml(r.website||'#')}" target="_blank">Website</a></div>
      </article>
    `).join('');
  }

  pageNum.textContent = page;
  stats.textContent = `${total} results • showing ${Math.min(total, start+1)} - ${end}`;
  statusEl.textContent = `Loaded ${rows.length} rows.`;
}

// helpers
function escapeHtml(s=''){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function debounce(fn, wait=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

// wire UI
stateFilter.addEventListener('change', applyFilters);
courseFilter.addEventListener('change', applyFilters);
ownershipFilter.addEventListener('change', applyFilters);
modeFilter.addEventListener('change', applyFilters);
searchBox.addEventListener('input', debounce(applyFilters, 220));
prevBtn.addEventListener('click', ()=>{ if (page > 1){ page--; renderPage(); }});
nextBtn.addEventListener('click', ()=>{ if ((page * PAGE_SIZE) < filtered.length){ page++; renderPage(); }});
btnReload.addEventListener('click', ()=> startParsing());
btnExport.addEventListener('click', exportVisibleCSV);

// CSV export of visible page
function exportVisibleCSV(){
  const start = (page - 1) * PAGE_SIZE;
  const slice = filtered.slice(start, start + PAGE_SIZE);
  if (!slice.length) return alert('No rows to export');
  const headers = ['name','type','ownership','mode','state','city','courses','fees','admission','cutoff','website'];
  const csv = [headers.join(',')].concat(slice.map(r => headers.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'colleges_export.csv'; a.click(); URL.revokeObjectURL(url);
}
</script>
</body>
</html>